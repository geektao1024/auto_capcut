python3 shengtu_simple.py


# 🎯 即梦图片生成脚本 - 完整说明文档

## 📌 版本信息

- **版本号**: v3.0
- **备份日期**: 2025-09-30
- **备份文件**: `shengtu_simple_v3.0_backup_20250930.py`
- **当前文件**: `shengtu_simple.py`

---

## 🎨 功能概述

本脚本是一个自动化工具，用于批量提交分镜到即梦AI图片生成平台。

### ✨ 核心功能

1. **自动提交分镜** - 批量处理分镜，自动识别角色并上传参考图
2. **智能选择** - 支持选择脚本文件和参考图目录
3. **灵活提交** - 三种提交模式（全部/指定编号/指定范围）
4. **循环处理** - 处理完后可继续提交其他分镜
5. **登录保持** - 浏览器状态保持，无需重复登录

### 🎯 主要特性

| 特性 | 说明 |
|------|------|
| **脚本选择** | 从 `jiaoben/` 文件夹或默认文件中选择 |
| **参考图选择** | 从 `reference_images/` 子文件夹中选择 |
| **智能识别** | 自动识别分镜中的角色名称 |
| **自动上传** | 根据角色名称自动上传对应参考图 |
| **页面刷新** | 每个分镜后刷新页面，避免页面闪动 |
| **登录检测** | 启动时检测登录状态 |
| **提交确认** | 检测提交后的成功/失败提示 |

---

## 📦 安装要求

### 系统要求
- Python 3.7+
- macOS / Windows / Linux

### 依赖库
```bash
pip install playwright
playwright install chromium
```

### 文件夹结构
```
playwright/
├── shengtu_simple.py              # 主程序
├── shengtu_simple_v3.0_backup_20250930.py  # 备份文件
├── jiaoben/                        # 分镜脚本文件夹
│   ├── 逛商场.txt
│   ├── 故事1.txt
│   └── ...
├── reference_images/               # 参考图文件夹
│   ├── 01/                        # 参考图集1
│   │   ├── 父亲.png
│   │   ├── 母亲.png
│   │   ├── 女儿.png
│   │   └── ...
│   ├── 02/                        # 参考图集2
│   │   ├── 父亲.png
│   │   ├── 母亲.png
│   │   └── ...
│   └── ...
├── 参考.txt                        # 默认分镜脚本
└── browser_data/                   # 浏览器数据（自动生成）
```

---

## 🚀 快速开始

### 1. 准备工作

#### 创建文件夹
```bash
mkdir -p jiaoben reference_images/01 reference_images/02
```

#### 准备分镜脚本
在 `jiaoben/` 文件夹中创建 `.txt` 文件，格式如下：

**TSV格式（推荐）**：
```
镜号	分镜提示词
1	角色:<br> * 女儿<br> * 母亲<br><br>机位与景别:<br> * 视角: 平视<br> * 景别: 中景<br>...
2	角色:<br> * 父亲<br> * 母亲<br><br>机位与景别:...
```

#### 准备参考图
在 `reference_images/01/` 或 `reference_images/02/` 中放置角色参考图：
- 文件名必须与角色名称完全匹配
- 支持格式：`.png`, `.jpg`, `.jpeg`, `.webp`, `.bmp`
- 例如：`父亲.png`, `母亲.png`, `女儿.png`

### 2. 运行脚本

```bash
python3 shengtu_simple.py
```

### 3. 操作流程

#### 步骤1: 选择分镜脚本
```
======================================================================
📝 检测到多个分镜脚本，请选择：
======================================================================
1️⃣  逛商场.txt (12.3 KB)
2️⃣  故事1.txt (5.2 KB)
3️⃣  参考.txt (默认, 2.3 KB)

请选择 (1-3): 1
```

#### 步骤2: 选择参考图目录
```
======================================================================
📁 检测到多个参考图文件夹，请选择：
======================================================================
1️⃣  01/ (4 张图片)
2️⃣  02/ (5 张图片)
3️⃣  使用根目录 reference_images/

请选择 (1-3): 1
```

#### 步骤3: 选择提交模式
```
======================================================================
📋 请选择提交模式
======================================================================
当前共有 5 个分镜

1️⃣  全部重新提交（从第1个开始）
2️⃣  从指定编号开始提交
3️⃣  提交指定范围（例如：第3-5个）

请选择模式 (1/2/3): 1
```

#### 步骤4: 等待处理
脚本会自动：
1. 启动浏览器
2. 导航到即梦平台
3. 检测登录状态（如未登录，等待用户登录）
4. 逐个处理分镜
5. 显示处理结果

#### 步骤5: 继续或退出
```
======================================================================
🔄 是否继续提交其他分镜？
======================================================================
1️⃣  是，继续提交
2️⃣  否，退出程序

请选择 (1/2): 
```

---

## ⚙️ 配置说明

### 脚本配置（在代码中）

```python
class Config:
    # 即梦平台地址
    JIMENG_URL = "https://jimeng.jianying.com/ai-tool/generate?type=image"
    
    # 文件路径
    STORYBOARD_FILE = Path.cwd() / "参考.txt"  # 默认分镜文件
    REFERENCE_DIR = Path.cwd() / "reference_images"  # 默认参考图目录
    BROWSER_DATA = Path.cwd() / "browser_data"  # 浏览器数据目录
    
    # 等待时间（秒）
    PAGE_LOAD_WAIT = 5      # 页面加载等待
    NAVIGATION_WAIT = 3     # 导航后等待
    SUBMIT_WAIT = 1         # 提交后等待
    INPUT_WAIT = 1          # 输入后等待
    
    # 参考图支持的格式
    REFERENCE_EXTS = [".png", ".jpg", ".jpeg", ".webp", ".bmp"]
```

### 可调整的参数

| 参数 | 默认值 | 说明 | 建议 |
|------|--------|------|------|
| `PAGE_LOAD_WAIT` | 5秒 | 页面加载等待时间 | 网络慢可增加到10秒 |
| `NAVIGATION_WAIT` | 3秒 | 导航后等待时间 | 一般不需要调整 |
| `SUBMIT_WAIT` | 1秒 | 提交后等待时间 | 快速提交可保持1秒 |
| `INPUT_WAIT` | 1秒 | 输入后等待时间 | 一般不需要调整 |

---

## 📖 功能详解

### 1. 脚本文件选择

**功能**: 从 `jiaoben/` 文件夹中选择分镜脚本

**智能逻辑**:
- `jiaoben/` 不存在 → 使用默认 `参考.txt`
- `jiaoben/` 为空 → 使用默认 `参考.txt`
- 有脚本文件 → 显示所有选项（包括默认文件）

**支持的文件格式**:
- `.txt` 文本文件
- 自动按文件名排序
- 显示文件大小（KB）

### 2. 参考图目录选择

**功能**: 从 `reference_images/` 子文件夹中选择参考图集

**智能逻辑**:
- 无子文件夹 → 使用根目录
- 有子文件夹 → 显示所有选项
- 自动统计每个文件夹的图片数量

**文件命名规则**:
- 文件名必须与角色名称完全匹配
- 例如：角色名 "父亲" → 文件名 "父亲.png"

### 3. 分镜格式解析

**支持两种格式**:

#### TSV格式（推荐）
```
镜号	分镜提示词
1	角色:<br> * 女儿<br> * 母亲<br><br>...
2	角色:<br> * 父亲<br> * 母亲<br><br>...
```

#### 故事格式
```
故事1：标题
角色:父亲,母亲
场景描述...

故事2：标题
角色:女儿
场景描述...
```

### 4. 角色识别

**支持两种格式**:

#### HTML格式（推荐）
```
角色:<br> * 女儿<br> * 母亲
```

#### 简单格式
```
角色:张三,李四
```

**识别逻辑**:
1. 查找 "角色:" 或 "角色：" 关键词
2. 提取后面的内容
3. HTML格式：提取所有 `* xxx` 列表项
4. 简单格式：按逗号、空格等分隔

### 5. 提交模式

#### 模式1: 全部重新提交
```
从第1个分镜开始，提交到最后一个
```

#### 模式2: 从指定编号开始
```
输入起始编号，从该编号提交到最后
例如：输入3 → 提交第3、4、5...个
```

#### 模式3: 指定范围提交
```
输入范围，只提交该范围内的分镜
例如：输入2-4 → 只提交第2、3、4个
```

### 6. 循环提交

**功能**: 处理完一批后可以继续提交其他分镜

**使用场景**:
- 分批处理大量分镜
- 重新提交失败的分镜
- 测试单个分镜

**优势**:
- 无需重启脚本
- 登录状态保留
- 浏览器保持打开

### 7. 登录检测

**自动检测登录状态**:
1. 启动后检查页面是否有输入框
2. 没有输入框 → 提示用户登录
3. 用户登录后按回车继续
4. 验证登录成功

**登录保持**:
- 浏览器数据保存在 `browser_data/`
- 下次启动自动使用保存的登录状态
- 无需重复登录

### 8. 提交按钮识别

**智能查找提交按钮**:
1. 按位置排序（选择最下面的按钮）
2. 检查是否禁用
3. 等待按钮可用（3秒）
4. 稳定页面（hover + scroll）
5. 三级点击策略（正常→强制→JS）

**提交确认**:
- 检查页面toast提示
- 识别成功/失败关键词
- 显示提交状态

---

## 💡 使用技巧

### 技巧1: 单个分镜提交
```
选择模式3（指定范围）
输入: 3-3
→ 只提交第3个分镜
```

### 技巧2: 快速重试失败的
```
第一轮: 全部提交
结果: 失败序号 2, 5

第二轮:
模式3 → 2-2  # 只提交第2个
继续
模式3 → 5-5  # 只提交第5个
```

### 技巧3: 分批处理大量分镜
```
假设有20个分镜:

第1批: 1-5
第2批: 6-10
第3批: 11-15
第4批: 16-20

每批处理完选择继续
```

### 技巧4: 测试后批量提交
```
1. 先测试第1个: 1-1
2. 确认正常
3. 继续提交: 从编号2开始
```

### 技巧5: 多角色参考图管理
```
reference_images/
├── 01/  # 故事1的角色
│   ├── 父亲.png
│   ├── 母亲.png
│   └── 女儿.png
└── 02/  # 故事2的角色
    ├── 老师.png
    ├── 学生.png
    └── 校长.png

不同故事使用不同的参考图集
```

---

## ❓ 常见问题

### Q1: 脚本启动后一直等待？
**A**: 检查是否需要登录。如果看到登录提示，请在浏览器中完成登录后按回车。

### Q2: 参考图上传失败？
**A**: 
- 检查文件名是否与角色名完全匹配
- 检查文件格式是否支持（png/jpg/jpeg/webp/bmp）
- 如果上传失败，可以在提交后手动上传

### Q3: 提交按钮无法点击？
**A**: 
- 脚本会等待3秒让按钮从禁用变为可用
- 检查输入框内容是否已填充
- 查看日志确认按钮是否找到

### Q4: 如何重新登录？
**A**: 删除 `browser_data/` 文件夹，重新运行脚本。

### Q5: 角色识别不准确？
**A**: 
- 确保分镜中有 "角色:" 或 "角色：" 关键词
- 使用HTML格式（`<br> * 角色名`）更准确
- 检查分镜格式是否正确

### Q6: 如何修改等待时间？
**A**: 编辑脚本中的 `Config` 类，修改对应的等待时间参数。

### Q7: 支持其他图片格式吗？
**A**: 当前支持 `.png`, `.jpg`, `.jpeg`, `.webp`, `.bmp`。可以在 `Config.REFERENCE_EXTS` 中添加其他格式。

### Q8: 可以同时打开多个浏览器吗？
**A**: 不建议。脚本使用持久化浏览器上下文，同时运行多个实例会冲突。

---

## 🔧 高级配置

### 自定义浏览器路径
```python
# 在 Config 类中添加
BROWSER_EXECUTABLE = "/path/to/your/chrome"
```

### 修改浏览器窗口大小
```python
# 在 init_browser 方法中添加
self.browser = await self.playwright.chromium.launch_persistent_context(
    user_data_dir=str(Config.BROWSER_DATA),
    headless=False,
    viewport={'width': 1920, 'height': 1080},  # 添加这行
    ...
)
```

### 添加日志到文件
```python
# 在日志配置部分修改
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('shengtu.log'),  # 添加文件处理器
        logging.StreamHandler()  # 保留控制台输出
    ]
)
```

---

## 📊 版本历史

### v3.0 (2025-09-30)
- ✅ 添加脚本文件选择功能
- ✅ 添加参考图目录选择功能
- ✅ 优化提交后等待时间（3秒→1秒）
- ✅ 恢复页面刷新逻辑（避免页面闪动）
- ✅ 完善登录检测功能
- ✅ 改进提交按钮识别（三级点击策略）
- ✅ 添加循环提交功能
- ✅ 支持三种提交模式

### v2.0 (2025-09-30)
- ✅ 提交按钮修复
- ✅ 登录校验
- ✅ 页面刷新优化
- ✅ 元素定位改进

### v1.0 (2025-09-30)
- ✅ 基础功能实现
- ✅ 自动提交分镜
- ✅ 角色识别
- ✅ 参考图上传

---

## 🛠️ 故障排查

### 检查清单
- [ ] Python版本是否 ≥ 3.7
- [ ] Playwright是否正确安装
- [ ] Chromium是否下载完成
- [ ] 文件夹结构是否正确
- [ ] 分镜文件格式是否正确
- [ ] 参考图文件名是否匹配角色名
- [ ] 网络连接是否正常

### 查看详细日志
脚本运行时会显示详细日志，注意查看：
- 文件读取信息
- 角色识别结果
- 参考图查找情况
- 按钮点击状态
- 提交结果

### 常见错误信息

| 错误信息 | 原因 | 解决方法 |
|---------|------|---------|
| `未找到可用的分镜脚本文件` | 脚本文件不存在 | 检查 `jiaoben/` 或 `参考.txt` |
| `未找到参考图: xxx.png` | 参考图文件不存在 | 添加对应的参考图文件 |
| `未找到可点击的提交按钮` | 按钮元素定位失败 | 检查页面是否加载完成 |
| `登录超时` | 用户未完成登录 | 在浏览器中完成登录 |

---

## 📞 技术支持

### 备份说明
- **备份文件**: `shengtu_simple_v3.0_backup_20250930.py`
- **备份时间**: 2025-09-30
- **备份原因**: v3.0 版本稳定，为后续升级保留

### 升级建议
下一版本可以考虑：
1. 添加图片生成完成后的自动下载功能
2. 支持批量下载生成的图片
3. 添加进度保存功能（中断后可继续）
4. 支持多线程处理
5. 添加图形界面（GUI）
6. 导出处理报告

### 注意事项
- 修改前请先备份当前版本
- 测试新功能前建议使用小批量数据
- 保持浏览器版本更新
- 定期清理 `browser_data/` 文件夹

---

## 📄 许可说明

本脚本仅供学习和个人使用，请遵守即梦平台的使用条款。

---

**版本**: v3.0  
**更新日期**: 2025-09-30  
**备份文件**: shengtu_simple_v3.0_backup_20250930.py  
**状态**: ✅ 稳定版本
