# 🔧 震动特效修复说明

## ✅ 已修复的问题

### 原问题
之前使用了错误的数据结构 `effects`，导致 CapCut 无法识别震动特效。

### 修复方案
改用 `material_animations` 结构，参考入场动画的成功实现。

---

## 🔍 验证方法

### 方法 1：在 CapCut 中检查

1. **运行脚本生成草稿**
   ```bash
   双击 "生成草稿.command"
   选择一个文件夹（带 ✅）
   启用分段并完成创建
   ```

2. **在 CapCut 中打开草稿**

3. **检查图片片段**
   - 点击时间轴上的任意图片片段
   - 查看右侧面板
   - 应该能看到"特效"或"动画"标签
   - 里面应该有"震动"特效

4. **预览效果**
   - 播放视频预览
   - 图片应该有轻微震动效果

---

### 方法 2：检查 JSON 文件

1. **找到生成的草稿文件夹**
   ```
   ~/Movies/CapCut/User Data/Projects/com.lveditor.draft/
   └── 最新草稿名称/
       └── draft_info.json
   ```

2. **搜索特效**
   ```bash
   cat draft_info.json | grep -A 10 "material_animations"
   ```

3. **应该看到**
   ```json
   "material_animations": [
     {
       "animations": [{
         "name": "震动",
         "type": "shake",
         "anim_adjust_params": {
           "speed": 0.2,
           "intensity": 0.5
         }
       }],
       "id": "...",
       "type": "video_effect"
     }
   ]
   ```

4. **检查图片片段引用**
   ```bash
   cat draft_info.json | grep "extra_material_refs"
   ```
   
   应该看到图片片段引用了震动特效的 ID。

---

## 🎨 修复后的数据结构

### 之前（错误）❌

```python
shake_effect = {
    "id": shake_effect_id,
    "type": "shake",
    "intensity": 5.0,
    # ... 简单结构
}
draft['materials']['effects'].append(shake_effect)  # ❌ 错误的位置
```

### 现在（正确）✅

```python
shake_effect = {
    "animations": [{
        "anim_adjust_params": {
            "intensity": 0.5,  # 转换为 0-1
            "speed": 0.2       # 转换为 0-1
        },
        "name": "震动",
        "type": "shake",
        "duration": -1,        # 整个片段
        # ... 完整参数
    }],
    "id": shake_effect_id,
    "type": "video_effect"
}
draft['materials']['material_animations'].append(shake_effect)  # ✅ 正确
```

---

## 🚨 如果还是不工作

### Plan B：从实际 CapCut 项目提取

如果修复后的结构还是不行，我们需要：

1. **手动创建一个测试项目**
   - 在 CapCut 中创建新项目
   - 添加一张图片
   - 手动添加"震动"特效
   - 调整参数（速度=2, 强度=5）
   - 保存项目

2. **导出 JSON 结构**
   ```bash
   # 找到你手动创建的草稿
   cd ~/Movies/CapCut/User\ Data/Projects/com.lveditor.draft/
   ls -lt | head -5
   
   # 复制最新的草稿
   cd 最新草稿名/
   cat draft_info.json | python3 -m json.tool > ~/Desktop/震动特效模板.json
   ```

3. **发给我分析**
   把 `震动特效模板.json` 文件内容发给我，我可以提取精确的震动特效结构。

---

## 🔍 调试信息

### 查看日志

```bash
cd /Users/mac/YouTube/01工具类/playwright/logs
ls -lt | head -1  # 找到最新日志
tail -50 最新日志.log | grep "特效"
```

应该看到：
```
🎨 添加震动画面特效...
✅ 震动特效配置: 速度=2.0, 强度=5.0
🎨 画面特效: 震动 (速度=2.0, 强度=5.0)
```

---

## 💡 临时解决方案

### 如果急需震动效果

在 CapCut 中手动添加：

1. 选中所有图片片段（Shift + 点击）
2. 点击"特效" → "画面特效"
3. 找到"震动"
4. 拖动到片段上
5. 调整参数：
   - 速度：2
   - 强度：5

**批量应用技巧：**
- 第一张图片设置好后
- 复制该片段（Cmd+C）
- 选中其他片段
- "粘贴属性" → 只选"特效"

---

## 📊 参数对照表

### 脚本参数 → CapCut 参数

| 脚本中 | 转换后 | CapCut 中 | 说明 |
|--------|--------|-----------|------|
| SHAKE_SPEED = 2.0 | 0.2 | 速度滑块 20% | 0-10 → 0-1 |
| SHAKE_INTENSITY = 5.0 | 0.5 | 强度滑块 50% | 0-10 → 0-1 |

### 如何验证转换正确

在 CapCut 中手动设置：
- 速度拉到 20%（2/10）
- 强度拉到 50%（5/10）

效果应该和脚本设置一致。

---

## 🔄 修复的关键变化

### 1. 数据位置

```python
# 之前 ❌
draft['materials']['effects']

# 现在 ✅  
draft['materials']['material_animations']
```

### 2. 数据结构

```python
# 现在使用嵌套的 animations 数组
{
  "animations": [{...}],  # 特效具体参数
  "id": "...",
  "type": "video_effect"
}
```

### 3. 参数范围

```python
# 转换为 0-1 范围
"intensity": SHAKE_INTENSITY / 10.0
"speed": SHAKE_SPEED / 10.0
```

---

## 🎯 下一步

### 测试新版本

```bash
# 1. 运行脚本
双击 "生成草稿.command"

# 2. 选择文件夹（带 ✅）
# 3. 在 CapCut 中验证

# 4. 如果成功看到震动效果 ✅
#    → 完成！

# 5. 如果还是没有 ❌
#    → 按照 Plan B 提取实际结构
```

---

## 📝 技术细节

### 为什么之前的方法不行

CapCut 的特效系统有特定的数据结构：

1. **material_animations** - 存储所有动画/特效
2. **animations 数组** - 每个特效的具体参数
3. **extra_material_refs** - 片段引用特效 ID

之前直接用 `effects` 是猜测的结构，实际 CapCut 不识别。

### 现在的方法为什么应该可行

参考了 `zidongjianji.py` 中成功的入场动画实现：
- 使用相同的 `material_animations` 位置
- 使用相同的嵌套结构
- 使用相同的引用方式

唯一区别是 `type` 从 `sticker_animation` 改为 `video_effect`。

---

## ✅ 成功标志

如果修复成功，你应该看到：

**在 CapCut 界面：**
- [x] 图片片段有特效标记
- [x] 点击片段能看到"震动"特效
- [x] 播放时图片有震动效果
- [x] 参数可以调整

**在日志中：**
- [x] "✅ 震动特效配置"
- [x] "🎨 画面特效: 震动"
- [x] 没有报错信息

---

**立即测试：** 运行脚本并在 CapCut 中验证！如果还是不行，我们可以用 Plan B 提取精确的 JSON 结构。🔧✨

